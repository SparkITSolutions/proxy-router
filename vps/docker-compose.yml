# VPS Docker Compose - Proxy Router Node
# Provides: WireGuard server, NordVPN client with kill switch, Tor for .onion access

services:
  # ===========================================================================
  # NordVPN Client with Fail-Shut Kill Switch
  # All internet-bound traffic from other containers goes through this
  # ===========================================================================
  nordvpn:
    build:
      context: ./docker/nordvpn
      dockerfile: Dockerfile
    container_name: nordvpn
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.disable_ipv6=1
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - NORDVPN_TOKEN=${NORDVPN_TOKEN}
      - NORDVPN_REGION=${NORDVPN_REGION:-us}
      - NORDVPN_TECHNOLOGY=${NORDVPN_TECHNOLOGY:-nordlynx}
      - NORDVPN_SERVER=${NORDVPN_SERVER:-}
      - ROTATION_INTERVAL=${ROTATION_INTERVAL:-3600}
      - DNS_SERVERS=${DNS_SERVERS:-103.86.96.100,103.86.99.100}
      - WG_PORT=${WG_PORT:-51820}
    volumes:
      - nordvpn_data:/var/lib/nordvpn
      # Mount entrypoint so we can update it without rebuilding
      - ./docker/nordvpn/entrypoint.sh:/entrypoint.sh:ro
    # Ports must be on nordvpn since wireguard uses network_mode: "service:nordvpn"
    ports:
      - "${WG_PORT:-51820}:51820/udp"
    healthcheck:
      test: ["CMD", "bash", "-c", "nordvpn status | grep -q 'Status: Connected'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # ===========================================================================
  # WireGuard Server
  # Accepts connections from Gateway VM(s) and GL.iNet routers
  # All traffic from WireGuard clients is routed through NordVPN
  # ===========================================================================
  wireguard:
    image: linuxserver/wireguard:latest
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-UTC}
      - SERVERURL=${VPS_PUBLIC_IP:-auto}
      - SERVERPORT=${WG_PORT:-51820}
      - PEERS=${WG_PEERS:-gateway,glinet}
      - PEERDNS=${PEERDNS:-103.86.96.100,103.86.99.100}
      - INTERNAL_SUBNET=${WG_SUBNET:-10.100.0.0}
      - ALLOWEDIPS=${WG_ALLOWED_IPS:-0.0.0.0/0}
    volumes:
      - ./config/wireguard:/config
      - /lib/modules:/lib/modules:ro
    # Use NordVPN's network stack so all WG client traffic goes through VPN
    # NOTE: ports are on nordvpn container since we use its network
    network_mode: "service:nordvpn"
    depends_on:
      nordvpn:
        condition: service_healthy

  # ===========================================================================
  # Tor (runs inside NordVPN network)
  # Provides VPN -> Tor chain for .onion access
  # Traffic: Gateway -> WireGuard -> NordVPN -> Tor -> Target
  # ===========================================================================
  tor:
    image: dockurr/tor:latest
    container_name: tor
    restart: unless-stopped
    # Use NordVPN's network - Tor traffic goes through VPN
    network_mode: "service:nordvpn"
    depends_on:
      nordvpn:
        condition: service_healthy

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  nordvpn_data:
